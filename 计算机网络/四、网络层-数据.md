

## 一、网络层概述与核心功能

### 1.1 网络层服务模型

#### 1.1.1 关键服务功能

|功能类型|描述|实现机制|
|---|---|---|
|**转发**|路由器将分组从输入链路转移到输出链路|基于转发表进行本地决策|
|**路由选择**|确定分组从源到目的地的路径|路由选择算法计算路径|
|**呼叫建立**|在数据传输前建立连接（如ATM网络）|信令协议协调资源分配|

#### 1.1.2 数据平面 vs 控制平面

|对比维度|**数据平面**|**控制平面**|
|---|---|---|
|**功能**|分组转发处理|路由决策计算|
|**时间尺度**|纳秒级（硬件实现）|秒级（软件实现）|
|**位置**|每台路由器内部|网络范围逻辑|
|**实现方式**|传统：每路由器控制  <br>现代：SDN分离||

### 1.2 网络服务模型

#### 1.2.1 因特网服务模型

- **尽力而为服务**：不保证交付、不保证时延、不保证带宽
- **简单性**：网络核心保持简单，智能置于网络边缘

#### 1.2.2 其他服务模型对比

|服务模型|保证内容|适用网络|
|---|---|---|
|**恒定比特率**|定时、有序、无损交付|ATM网络|
|**可用比特率**|最小信元速率保证|ATM网络|
|**差异化服务**|不同服务等级|现代IP网络|

## 二、路由器工作原理详解

### 2.1 路由器体系结构组件

```
输入端口 → 交换结构 → 输出端口
         ↓
   路由选择处理器
```

#### 2.1.1 输入端口功能

- **线路端接**：物理层信号接收与处理
- **数据链路处理**：帧解封装，提取IP数据报
- **查找与转发**：查询转发表确定输出端口
- **排队**：缓存等待处理的分组

#### 2.1.2 交换结构类型

|类型|工作原理|优缺点|
|---|---|---|
|**经内存交换**|CPU直接控制内存拷贝|简单但速率受限|
|**经总线交换**|共享总线传输|成本低但带宽受限|
|**经互联网络**|多条并行路径|高性能，复杂度高|

#### 2.1.3 输出端口功能

- **排队缓冲**：存储待发送分组
- **数据链路处理**：封装成帧
- **线路端接**：物理层信号发送

### 2.2 分组排队与调度

#### 2.2.1 排队位置与影响

- **输入排队**：HOL（队头阻塞）问题
- **输出排队**：缓存溢出导致丢包

#### 2.2.2 分组调度算法

|调度算法|工作原理|公平性|复杂度|
|---|---|---|---|
|**FIFO**|先到先服务|差|低|
|**优先权排队**|按优先级服务|差|中|
|**循环(RR)**|轮流服务各类别|好|中|
|**加权公平排队(WFQ)**|按权重分配带宽|很好|高|

#### 2.2.3 主动队列管理(AQM)

- **随机早期检测(RED)**：提前丢包避免同步重传
- **PIE**：基于时延的队列管理
- **CoDel**：控制时延的主动队列管理

## 三、网际协议(IP)

### 3.1 IPv4数据报格式

```
 0                   16                   31
|版本|首部长度|服务类型|        数据报长度        |
|       标识       |标志|      片偏移          |
|  生存时间  |协议 |        首部检验和        |
|                源IP地址                    |
|                目的IP地址                   |
|                选项（可选）                 |
|                  数据                      |
```

#### 3.1.1 关键字段详解

- **版本(4比特)**：IP协议版本（IPv4=4）
- **首部长度(4比特)**：以4字节为单位的首部长度
- **服务类型(8比特)**：区分服务编码点(DSCP)
- **数据报长度(16比特)**：首部+数据的总长度
- **标识、标志、片偏移**：用于分片与重组
- **生存时间(8比特)**：防止分组无限循环
- **协议(8比特)**：指示上层协议（TCP=6，UDP=17）
- **首部检验和(16比特)**：检测首部差错

### 3.2 IPv4编址体系

#### 3.2.1 IP地址结构

- **点分十进制表示**：如192.168.1.1
- **网络部分**：标识所属网络
- **主机部分**：标识网络内特定主机

#### 3.2.2 子网与CIDR

**子网划分示例**：

```
IP地址：223.1.1.100
子网掩码：255.255.255.0
网络前缀：223.1.1.0/24
可用主机：223.1.1.1 - 223.1.1.254
```

**CIDR优势**：

- 消除分类地址限制
- 提高地址分配效率
- 支持路由聚合

#### 3.2.3 特殊IP地址

|地址范围|用途|说明|
|---|---|---|
|127.0.0.0/8|环回地址|本地测试|
|10.0.0.0/8|专用地址|内部网络|
|172.16.0.0/12|专用地址|内部网络|
|192.168.0.0/16|专用地址|内部网络|
|169.254.0.0/16|链路本地|自动配置|

### 3.3 动态主机配置协议(DHCP)

#### 3.3.1 DHCP工作流程

```
发现 → 提供 → 请求 → 确认
```

#### 3.3.2 DHCP报文类型

|报文类型|功能|方向|
|---|---|---|
|DHCPDISCOVER|客户端发现服务器|客户端→服务器|
|DHCPOFFER|服务器提供配置|服务器→客户端|
|DHCPREQUEST|客户端请求配置|客户端→服务器|
|DHCPACK|服务器确认分配|服务器→客户端|

### 3.4 网络地址转换(NAT)

#### 3.4.1 NAT工作原理

```
专用网络 → NAT路由器 → 公共因特网
10.0.0.0/8    |     公共IP地址
               |
         转换表维护映射关系
```

#### 3.4.2 NAT转换表示例

|专用地址:端口|公共地址:端口|
|---|---|
|10.0.0.1:3345|138.76.29.7:5001|
|10.0.0.2:4431|138.76.29.7:5002|

#### 3.4.3 NAT争议与解决方案

- **争议**：违反端到端原则，阻碍P2P应用
- **解决方案**：UPnP、ICE、STUN/TURN协议

### 3.5 IPv6协议

#### 3.5.1 IPv6改进特性

- **扩展地址空间**：128位地址，解决地址耗尽问题
- **简化首部格式**：固定40字节首部，提高处理效率
- **流标签支持**：服务质量(QoS)支持
- **内置安全**：IPsec成为标准组成部分

#### 3.5.2 IPv6数据报格式

```
 0                   16                   31
|        版本        |    流量类别    |    流标签     |
|        有效载荷长度        |   下一个首部   |   跳限制     |
|                源地址（128位）                 |
|                目的地址（128位）                |
|                  数据                         |
```

#### 3.5.3 IPv4向IPv6过渡技术

- **双栈技术**：设备同时支持IPv4和IPv6
- **隧道技术**：IPv6分组封装在IPv4分组中传输
- **协议转换**：NAT-PT进行协议转换

## 四、泛化转发与SDN

### 4.1 匹配加操作抽象

#### 4.1.1 流表结构

|匹配字段|优先级|计数器|操作|超时|
|---|---|---|---|---|
|入端口、MAC、IP等|匹配优先级|统计信息|转发、丢弃等|表项有效期|

#### 4.1.2 匹配字段范围

- **链路层**：入端口、源/目的MAC地址、以太网类型
- **网络层**：源/目的IP地址、IP协议、IP服务类型
- **运输层**：源/目的端口号

#### 4.1.3 操作类型

- **转发**：到端口、控制器或本地
- **丢弃**：静默丢弃分组
- **修改字段**：重写MAC、IP、端口等字段

### 4.2 OpenFlow协议示例

#### 4.2.1 简单转发示例

```
# 流表项：转发特定流量到端口4
匹配：入端口=1, IP源=10.3.*.*, IP目的=10.2.*.*
操作：转发(4)
```

#### 4.2.2 负载均衡示例

```
# 流表项：基于IP地址哈希进行负载均衡
匹配：IP目的=10.2.0.0/16
操作：组表(负载均衡组)
```

#### 4.2.3 防火墙示例

```
# 流表项：阻止特定流量
匹配：IP源=10.1.0.1, IP目的=10.2.0.3, 协议=UDP
操作：丢弃
```

## 五、中间盒功能

### 5.1 中间盒分类

|类型|功能|示例设备|
|---|---|---|
|**NAT设备**|网络地址转换|路由器、防火墙|
|**防火墙**|流量过滤、安全策略|专用防火墙设备|
|**入侵检测系统**|安全威胁检测|IDS/IPS设备|
|**负载均衡器**|流量分发|应用交付控制器|
|**缓存代理**|内容缓存加速|Web缓存服务器|

### 5.2 中间盒部署挑战

- **路径约束**：流量必须经过特定中间盒
- **策略冲突**：不同中间盒策略可能冲突
- **管理复杂度**：分布式设备难以统一管理

## 六、关键技术与概念对比

### 6.1 IPv4 vs IPv6对比

|特性|**IPv4**|**IPv6**|
|---|---|---|
|**地址长度**|32位|128位|
|**地址表示**|点分十进制|冒号分隔十六进制|
|**首部长度**|可变（20-60字节）|固定40字节|
|**分片处理**|路由器和主机|仅主机|
|**配置方式**|手动或DHCP|自动配置|
|**安全性**|可选（IPsec）|内置（IPsec）|

### 6.2 传统转发 vs 泛化转发

|特性|**传统基于目的地转发**|**泛化转发**|
|---|---|---|
|**匹配依据**|目的IP地址|多字段组合|
|**操作类型**|转发到输出端口|丰富操作集合|
|**灵活性**|有限|极高|
|**控制粒度**|粗粒度|细粒度|
|**典型应用**|传统IP网络|SDN网络|

### 6.3 路由器排队策略比较

|策略|公平性|时延性能|实现复杂度|适用场景|
|---|---|---|---|---|
|**FIFO**|差|可变|低|一般网络|
|**优先权排队**|很差|高优先级好|中|实时应用|
|**WFQ**|很好|可预测|高|服务质量要求高|

## 七、实践应用案例

### 7.1 企业网络设计案例

```
互联网接入 → 防火墙/NAT → 核心交换机 → 各部门子网
                 ↓
            DHCP服务器分配地址
                 ↓
            VLAN划分管理流量
```

### 7.2 数据中心网络案例

- **Leaf-Spine架构**：消除过度订阅
- **ECMP**：多路径负载均衡
- **SDN控制**：集中流量工程

### 7.3 物联网编址方案

- **IPv6优势**：海量地址支持设备连接
- **6LoWPAN**：IPv6 over低功耗无线网络
- **自动配置**：减少管理开销

---

**本章核心总结**：

1. 网络层数据平面负责分组转发，核心设备是路由器
2. IPv4和IPv6是主要的网络层协议，CIDR解决了地址分配效率问题
3. 路由器通过转发表进行分组转发，涉及复杂的排队和调度机制
4. SDN和泛化转发提供了更灵活的网络控制能力
5. NAT、DHCP等协议解决了实际部署中的关键问题

**下一章预告**：第5章将深入探讨网络层控制平面，研究路由选择算法和协议的工作原理。

### 附录：第4章英文缩写与汉语意思对照表

|英文缩写|英文全称|汉语意思|
|---|---|---|
|**IP**|Internet Protocol|网际协议|
|**IPv4**|Internet Protocol version 4|网际协议版本4|
|**IPv6**|Internet Protocol version 6|网际协议版本6|
|**CIDR**|Classless Inter-Domain Routing|无类别域间路由选择|
|**DHCP**|Dynamic Host Configuration Protocol|动态主机配置协议|
|**NAT**|Network Address Translation|网络地址转换|
|**SDN**|Software-Defined Networking|软件定义网络|
|**OpenFlow**|OpenFlow Protocol|开放流协议|
|**AQM**|Active Queue Management|主动队列管理|
|**RED**|Random Early Detection|随机早期检测|
|**FIFO**|First-In-First-Out|先进先出|
|**WFQ**|Weighted Fair Queuing|加权公平排队|
|**HOL**|Head-of-Line|队头阻塞|
|**DSCP**|Differentiated Services Code Point|差异化服务编码点|
|**MTU**|Maximum Transmission Unit|最大传输单元|
|**ICMP**|Internet Control Message Protocol|网际控制报文协议|
|**ARP**|Address Resolution Protocol|地址解析协议|
|**VPN**|Virtual Private Network|虚拟专用网络|
|**QoS**|Quality of Service|服务质量|
|**MPLS**|Multiprotocol Label Switching|多协议标签交换|